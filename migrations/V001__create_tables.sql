CREATE TABLE users (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR(255) NOT NULL
);

CREATE TABLE medications (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR(255) NOT NULL
);

CREATE TABLE schedules (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  medication_id BIGINT NOT NULL REFERENCES medications(id) ON DELETE CASCADE,
  frequency INTERVAL NOT NULL,
  duration INTERVAL,
  start_date TIMESTAMP NOT NULL DEFAULT NOW(),
  end_date TIMESTAMP GENERATED ALWAYS AS (
    CASE WHEN duration IS NOT NULL THEN start_date + duration ELSE NULL END
  ) STORED,
  CONSTRAINT check_frequency_range CHECK (
    frequency >= INTERVAL '1 hour' AND frequency <= INTERVAL '1 day'
  )
);

CREATE TABLE takings (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  schedule_id BIGINT REFERENCES schedules(id) ON DELETE CASCADE,
  taking_time TIMESTAMP NOT NULL,
  CONSTRAINT valid_taking_time CHECK (
      EXTRACT(HOUR FROM taking_time) BETWEEN 8 AND 21
      AND (EXTRACT(MINUTE FROM taking_time)::INTEGER % 15 = 0)
  )
);
